
select distinct
SFRSTCR_TERM_CODE,SSBSECT_CRN,GOBTPAC_EXTERNAL_USER,SGBSTDN_STYP_CODE,
SGBSTDN_TERM_CODE_EFF,SPRIDEN_LAST_NAME STUDENT_LAST_NAME,
SPRIDEN_FIRST_NAME STUDENT_FIRST_NAME,SSBSECT_SUBJ_CODE,SSBSECT_CRSE_NUMB,SSBSECT_SEQ_NUMB,
SSBSECT_CAMP_CODE,SPBPERS_BIRTH_DATE,

--SQ FOR EMAIL
(SELECT A.GOBTPAC_EXTERNAL_USER
FROM GOBTPAC A

WHERE A.GOBTPAC_PIDM=SFRSTCR_PIDM) || '@cctech.edu' STUDENT_EMAIL,
--END SQ EMAIL

--SUBQUERY FOR BIRTH DATE COLUMN
(SELECT TO_CHAR(A.SPBPERS_BIRTH_DATE, 'YYYY-MM-DD')
FROM SPBPERS A

WHERE A.SPBPERS_PIDM=SFRSTCR_PIDM) BIRTH_DATE,
--END SUBQUERY

--NEW SUBQUERY FOR INSTRUCTOR LAST NAME
(SELECT A.SPRIDEN_LAST_NAME
FROM SPRIDEN A,SIRASGN

WHERE A.SPRIDEN_PIDM=SIRASGN_PIDM
AND SIRASGN_CRN=SSBSECT_CRN
AND SIRASGN_TERM_CODE= SSBSECT_TERM_CODE
AND SIRASGN_PRIMARY_IND = 'Y'
AND A.SPRIDEN_CHANGE_IND IS NULL) INSTRUCTOR_LAST_NAME,
--END SUBQUERY

--NEW SUBQUERY FOR INSTRUCTOR FIRST NAME
(SELECT A.SPRIDEN_FIRST_NAME
FROM SPRIDEN A,SIRASGN

WHERE A.SPRIDEN_PIDM=SIRASGN_PIDM
AND SIRASGN_CRN=SSBSECT_CRN
AND SIRASGN_TERM_CODE= SSBSECT_TERM_CODE
AND SIRASGN_PRIMARY_IND = 'Y'
AND A.SPRIDEN_CHANGE_IND IS NULL) INSTRUCTOR_FIRST_NAME,
--END SUBQUERY


--SQ FOR INSTRUCTORS FULL NAME
(SELECT 
    A.SPRIDEN_FIRST_NAME || ' ' || A.SPRIDEN_LAST_NAME 
FROM 
    SPRIDEN A,SIRASGN
WHERE 
    A.SPRIDEN_PIDM = SIRASGN_PIDM
    AND SIRASGN_CRN = SSBSECT_CRN
    AND SIRASGN_TERM_CODE = SSBSECT_TERM_CODE
    AND SIRASGN_PRIMARY_IND = 'Y'
    AND A.SPRIDEN_CHANGE_IND IS NULL) INSTRUCTOR_FULL_NAME,
--END SQ FULL NAME

--SQ FOR INSTRUCTOR EMAIL
(SELECT A.GOBTPAC_EXTERNAL_USER
FROM GOBTPAC A,SIRASGN A,SPRIDEN A

WHERE A.SIRASGN_PIDM=A.GOBTPAC_PIDM
AND A.SPRIDEN_PIDM=SIRASGN_PIDM
AND A.SPRIDEN_CHANGE_IND IS NULL
AND SIRASGN_CRN=SSBSECT_CRN
AND SIRASGN_TERM_CODE= SSBSECT_TERM_CODE
AND SIRASGN_PRIMARY_IND = 'Y') || '@cctech.edu' INSTRUCTOR_EMAIL
--END SUBQUERY


from sfrstcr,ssbsect,gobtpac,sgbstdn,spriden,SPBPERS

where gobtpac_pidm=sfrstcr_pidm
and sfrstcr_pidm=sgbstdn_pidm
and ssbsect_crn=sfrstcr_crn
and ssbsect_term_code=sfrstcr_term_code
and spbpers_pidm=sfrstcr_pidm
and spriden_pidm=sfrstcr_pidm

and SFRSTCR_RSTS_CODE IN ('RE','RW','AU','AW','WS','WM')
and spriden_change_ind IS NULL
and sfrstcr_term_code = 202320

AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(A.SGBSTDN_TERM_CODE_EFF)
                                FROM SGBSTDN A
                                WHERE A.SGBSTDN_PIDM = SFRSTCR_PIDM
                                  AND A.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE)
                                  --count's 5890 as of 22feb2024
AND SSBSECT_CAMP_CODE != 'H' AND SGBSTDN_STYP_CODE != 'D'

